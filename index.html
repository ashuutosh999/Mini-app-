<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Base Snake üü¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0052FF">

<meta property="fc:miniapp" content='{
  "version": "next",
  "imageUrl": "https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg", 
  "button": {
    "title": "Play Base Snake",
    "action": {
      "type": "launch_miniapp",
      "name": "Base Snake",
      "url": "https://your-vercel-url.vercel.app", 
      "splashImageUrl": "https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg",
      "splashBackgroundColor": "#050510"
    }
  }
}' />

<style>
  /* ... (Keep your existing CSS exactly as it was) ... */
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap');

  :root {
    --base-blue: #0052FF;
    --neon-blue: #00e5ff;
    --neon-pink: #ff00ff;
    --bg-dark: #050510;
  }

  body {
    margin: 0;
    background-color: var(--bg-dark);
    background-image: 
      linear-gradient(rgba(0, 82, 255, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 82, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
    font-family: 'Rajdhani', sans-serif;
    overflow: hidden;
    touch-action: none;
  }

  #ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .screen {
    pointer-events: auto;
    background: rgba(0, 0, 0, 0.9);
    border: 2px solid var(--base-blue);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    backdrop-filter: blur(5px);
    box-shadow: 0 0 20px rgba(0, 82, 255, 0.4);
    width: 85%;
    max-width: 320px;
    display: none;
  }
  
  .screen.active { display: block; }

  h1 { 
    font-family: 'Press Start 2P', cursive; 
    color: var(--base-blue); 
    text-shadow: 2px 2px #fff;
    font-size: 22px;
    margin-bottom: 20px;
    line-height: 1.4;
  }

  input {
    background: #111;
    border: 1px solid var(--base-blue);
    color: white;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    font-family: 'Rajdhani', sans-serif;
  }

  button {
    background: var(--base-blue);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s;
    font-family: 'Press Start 2P', cursive;
    width: 100%;
    margin-top: 8px;
  }
  
  button:active { transform: scale(0.95); }
  button:disabled { background: #555; cursor: not-allowed; }

  .wallet-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: #1a1a2e;
    border: 1px solid #333;
    margin-bottom: 10px;
  }
  .wallet-btn:hover { background: #2a2a40; border-color: var(--base-blue); }
  .wallet-icon { width: 24px; height: 24px; }

  #hud {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: 400px;
    padding: 10px;
    box-sizing: border-box;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 0 0 5px var(--neon-blue);
  }

  canvas {
    background: rgba(0,0,0,0.8);
    border: 2px solid var(--base-blue);
    border-radius: 12px;
    box-shadow: 0 0 15px var(--base-blue);
    display: block;
  }

  .leaderboard-container {
    margin-top: 15px;
    width: 90%;
    max-width: 350px;
    background: rgba(0,0,0,0.6);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 14px;
  }
  
  .lb-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #222;
  }
  .lb-rank { color: var(--neon-pink); font-weight: bold; }
  .lb-name { color: white; }
  .lb-score { color: var(--neon-blue); }

  .mobile-hint {
    margin-top: 10px;
    color: #666;
    font-size: 12px;
    display: none;
  }
  @media (hover: none) {
    .mobile-hint { display: block; }
  }
  
  #finalScore {
    font-size: 32px;
    color: var(--neon-blue);
    font-weight: bold;
    text-shadow: 0 0 10px var(--neon-blue);
  }

</style>
</head>
<body>

  <div id="hud">
    <div id="scoreDisplay">SCORE: 0</div>
    <div id="walletDisplay">üî¥ Not Connected</div>
  </div>

  <canvas id="game"></canvas>

  <div class="mobile-hint">üëÜ Swipe to turn ‚Ä¢ Tap to speed up</div>

  <div class="leaderboard-container">
    <div style="text-align:center; color: var(--base-blue); font-weight:bold; margin-bottom:5px;">üèÜ MONTHLY LEADERS</div>
    <div id="leaderboardList">Loading...</div>
  </div>

  <div id="ui-layer">
    
    <div id="screen-connect" class="screen active">
      <h1>BASE SNAKE</h1>
      <p style="margin-bottom:20px; color:#aaa; font-size:14px;">Connect wallet to play & save scores on-chain.</p>
      <button onclick="showScreen('screen-wallet-select')">üîó CONNECT WALLET</button>
    </div>

    <div id="screen-wallet-select" class="screen">
      <h1>CHOOSE WALLET</h1>
      
      <button class="wallet-btn" onclick="connectSpecificWallet('metamask')">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="wallet-icon" alt="MetaMask">
        MetaMask
      </button>

      <button class="wallet-btn" onclick="connectSpecificWallet('coinbase')">
        <img src="https://avatars.githubusercontent.com/u/18060234?s=200&v=4" class="wallet-icon" alt="Coinbase">
        Coinbase Wallet
      </button>

      <div style="margin-top:15px; font-size:12px; color:#666; cursor:pointer;" onclick="showScreen('screen-connect')">
        ‚Üê Go Back
      </div>
    </div>

    <div id="screen-register" class="screen">
      <h1>NEW PLAYER</h1>
      <p style="font-size:14px; color:#aaa; margin-bottom:15px;">Enter a username to link to your wallet.</p>
      <input type="text" id="usernameInput" placeholder="CryptoSnake123" maxlength="12">
      <br>
      <button onclick="registerUser()">REGISTER</button>
    </div>

    <div id="screen-start" class="screen">
      <h1 id="welcomeMsg">WELCOME</h1>
      <p style="margin-bottom:20px;">Personal Best: <span id="personalBest" style="color:var(--neon-blue)">0</span></p>
      <button onclick="startGame()">‚ñ∂ START GAME</button>
    </div>

    <div id="screen-gameover" class="screen">
      <h1 style="color:var(--neon-pink)">GAME OVER</h1>
      <p>Score: <span id="finalScore">0</span></p>
      <button id="btnSave" onclick="submitScore()">üíæ SAVE ON-CHAIN</button>
      <button onclick="startGame()">üîÑ RESTART</button>
    </div>

  </div>

<script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk@0.0.1/dist/index.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script>
// --- REQUIRED: Initialize Mini App ---
// This tells the Base app that your game has loaded and is ready to show.
window.addEventListener('DOMContentLoaded', () => {
    if (window.farcaster && window.farcaster.sdk) {
        window.farcaster.sdk.actions.ready();
    }
});

// --- CONFIGURATION ---
const CONTRACT_ADDRESS = "0x1A7CcE659Ad0f71Ddc9f2Af9f4d1F155A8291BDd"; 

const ABI = [
  "function registerUser(string username) public",
  "function saveScore(uint256 score) public",
  "function getPlayer(address _addr) public view returns (string, uint256)",
  "event NewScore(address indexed player, string username, uint256 score, uint256 timestamp)",
  "event UserRegistered(address indexed player, string username)"
];

// --- GAME VARIABLES ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const setCanvasSize = () => {
    const size = Math.min(window.innerWidth - 20, 400);
    canvas.width = size;
    canvas.height = size;
};
setCanvasSize();
window.addEventListener('resize', setCanvasSize);

const box = 20; 
let snake, dir, nextDir, food, score, gameLoop;
let isPlaying = false;

// --- WALLET STATE ---
let provider, signer, contract;
let userAddress, currentUsername;

/* ================= UI NAVIGATION ================= */
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

/* ================= SCORE ANIMATION ================= */
function animateScore(targetScore) {
    const scoreElement = document.getElementById("finalScore");
    let current = 0;
    const duration = 1000;
    const startTime = performance.now();

    function update(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 3);
        current = Math.floor(ease * targetScore);
        scoreElement.innerText = current;

        if (progress < 1) requestAnimationFrame(update);
        else scoreElement.innerText = targetScore;
    }
    requestAnimationFrame(update);
}

/* ================= WEB3 LOGIC ================= */
function getProvider(type) {
    const eth = window.ethereum;
    if (!eth) return null;
    if (eth.providers && Array.isArray(eth.providers)) {
        if (type === 'coinbase') return eth.providers.find(p => p.isCoinbaseWallet);
        if (type === 'metamask') return eth.providers.find(p => p.isMetaMask);
    }
    if (type === 'coinbase' && eth.isCoinbaseWallet) return eth;
    if (type === 'metamask' && eth.isMetaMask) return eth;
    if (type === 'metamask' && !eth.isCoinbaseWallet) return eth;
    return null;
}

async function connectSpecificWallet(walletType) {
    if (!window.ethereum) return alert("No wallet found. Please install MetaMask or Coinbase Wallet.");

    const specificProvider = getProvider(walletType);
    if (!specificProvider) {
        alert(`${walletType === 'coinbase' ? 'Coinbase Wallet' : 'MetaMask'} not found. Please check your extension.`);
        return;
    }

    try {
        provider = new ethers.providers.Web3Provider(specificProvider);
        await provider.send("eth_requestAccounts", []);
        
        const network = await provider.getNetwork();
        if (network.chainId !== 8453 && network.chainId !== 84532) {
             alert("Please switch to Base Network!");
        }

        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        document.getElementById("walletDisplay").innerHTML = 
            `üü¢ ${userAddress.slice(0,4)}...${userAddress.slice(-4)}`;

        checkRegistration();
        fetchLeaderboard(); 

    } catch (err) {
        console.error(err);
        alert("Connection Failed or Cancelled");
    }
}

async function checkRegistration() {
    try {
        const player = await contract.getPlayer(userAddress);
        if (!player[0]) {
            showScreen('screen-register');
        } else {
            currentUsername = player[0];
            document.getElementById("welcomeMsg").innerText = `HI, ${currentUsername.toUpperCase()}`;
            document.getElementById("personalBest").innerText = player[1].toString();
            showScreen('screen-start');
        }
    } catch (e) {
        console.log("Contract Error", e);
        showScreen('screen-register'); 
    }
}

async function registerUser() {
    const name = document.getElementById("usernameInput").value;
    if (!name || name.length > 12) return alert("Invalid Name (1-12 chars)");

    try {
        const tx = await contract.registerUser(name);
        document.querySelector('#screen-register button').innerText = "REGISTERING...";
        await tx.wait();
        
        currentUsername = name;
        showScreen('screen-start');
    } catch (err) {
        alert("Registration failed: " + err.message);
        document.querySelector('#screen-register button').innerText = "REGISTER";
    }
}

async function submitScore() {
    if (!contract) return;
    try {
        const btn = document.getElementById('btnSave');
        btn.innerText = "SIGNING...";
        btn.disabled = true;

        const tx = await contract.saveScore(score);
        btn.innerText = "MINING...";
        await tx.wait();
        
        btn.innerText = "SAVED! ‚úÖ";
        fetchLeaderboard(); 
    } catch (err) {
        alert("Error saving: " + err.message);
        document.getElementById('btnSave').disabled = false;
        document.getElementById('btnSave').innerText = "üíæ SAVE ON-CHAIN";
    }
}

/* ================= LEADERBOARD LOGIC ================= */
async function fetchLeaderboard() {
    if (!contract) {
        document.getElementById("leaderboardList").innerText = "Connect wallet to view";
        return;
    }
    
    try {
        const filter = contract.filters.NewScore();
        const events = await contract.queryFilter(filter, -5000); 

        const currentMonth = new Date().getMonth();
        let scores = [];

        events.forEach(e => {
            const d = new Date(e.args.timestamp * 1000);
            if (d.getMonth() === currentMonth) {
                scores.push({
                    name: e.args.username,
                    score: e.args.score.toNumber()
                });
            }
        });

        scores.sort((a,b) => b.score - a.score);
        const top5 = scores.slice(0, 5);

        const list = document.getElementById("leaderboardList");
        if(top5.length === 0) {
            list.innerHTML = "<div style='text-align:center; padding:10px;'>No scores this month yet!</div>";
        } else {
            list.innerHTML = top5.map((s, i) => `
                <div class="lb-row">
                    <span class="lb-rank">#${i+1}</span>
                    <span class="lb-name">${s.name}</span>
                    <span class="lb-score">${s.score}</span>
                </div>
            `).join('');
        }
    } catch(e) {
        console.log("Error loading leaderboard", e);
    }
}

/* ================= GAME LOGIC ================= */
function startGame() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    
    snake = [{ x: 10 * box, y: 10 * box }];
    dir = "RIGHT";
    nextDir = "RIGHT";
    score = 0;
    document.getElementById("scoreDisplay").innerText = "SCORE: 0";
    
    placeFood();
    isPlaying = true;
    
    if (gameLoop) clearInterval(gameLoop);
    gameLoop = setInterval(draw, 100);
}

function placeFood() {
    const cols = Math.floor(canvas.width / box);
    const rows = Math.floor(canvas.height / box);
    food = {
        x: Math.floor(Math.random() * cols) * box,
        y: Math.floor(Math.random() * rows) * box
    };
}

function draw() {
    ctx.fillStyle = "rgba(5, 5, 16, 0.6)"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.shadowBlur = 15;
    ctx.shadowColor = "#ff00ff";
    ctx.fillStyle = "#ff00ff";
    ctx.fillRect(food.x, food.y, box-2, box-2);
    ctx.shadowBlur = 0;

    for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = (i === 0) ? "#ffffff" : "#0052FF"; 
        ctx.shadowBlur = (i === 0) ? 10 : 0;
        ctx.shadowColor = "#ffffff";
        ctx.fillRect(snake[i].x, snake[i].y, box-2, box-2);
        ctx.shadowBlur = 0;
    }

    let snakeX = snake[0].x;
    let snakeY = snake[0].y;

    dir = nextDir; 
    if (dir === "LEFT") snakeX -= box;
    if (dir === "UP") snakeY -= box;
    if (dir === "RIGHT") snakeX += box;
    if (dir === "DOWN") snakeY += box;

    if (snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(snakeX, snakeY, snake)) {
        gameOver();
        return;
    }

    if (snakeX === food.x && snakeY === food.y) {
        score++;
        document.getElementById("scoreDisplay").innerText = "SCORE: " + score;
        placeFood();
    } else {
        snake.pop();
    }

    let newHead = { x: snakeX, y: snakeY };
    snake.unshift(newHead);
}

function collision(x, y, array) {
    for (let i = 0; i < array.length; i++) {
        if (x === array[i].x && y === array[i].y) return true;
    }
    return false;
}

function gameOver() {
    isPlaying = false;
    clearInterval(gameLoop);
    showScreen('screen-gameover');
    animateScore(score);
    document.getElementById('btnSave').disabled = false;
    document.getElementById('btnSave').innerText = "üíæ SAVE ON-CHAIN";
}

// Controls
document.addEventListener("keydown", direction);
function direction(event) {
    const key = event.keyCode;
    if ((key == 37 || key == 65) && dir != "RIGHT") nextDir = "LEFT";
    else if ((key == 38 || key == 87) && dir != "DOWN") nextDir = "UP";
    else if ((key == 39 || key == 68) && dir != "LEFT") nextDir = "RIGHT";
    else if ((key == 40 || key == 83) && dir != "UP") nextDir = "DOWN";
}

let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', function(event) {
    touchStartX = event.changedTouches[0].screenX;
    touchStartY = event.changedTouches[0].screenY;
}, false);

document.addEventListener('touchend', function(event) {
    let touchEndX = event.changedTouches[0].screenX;
    let touchEndY = event.changedTouches[0].screenY;
    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
}, false);

function handleSwipe(startX, startY, endX, endY) {
    let xDiff = endX - startX;
    let yDiff = endY - startY;

    if (Math.abs(xDiff) > Math.abs(yDiff)) {
        if (xDiff > 0 && dir != "LEFT") nextDir = "RIGHT";
        else if (xDiff < 0 && dir != "RIGHT") nextDir = "LEFT";
    } else {
        if (yDiff > 0 && dir != "UP") nextDir = "DOWN";
        else if (yDiff < 0 && dir != "DOWN") nextDir = "UP";
    }
}
</script>
</body>
</html>
