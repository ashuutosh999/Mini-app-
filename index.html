<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Base Snakes üü¶</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0052FF">

<meta property="og:title" content="Base Snakes üêç" />
<meta property="og:description" content="Play the ultimate crypto snake game on Base!" />
<meta property="og:image" content="https://mini-app-phi-ashen.vercel.app/Gemini_Generated_Image_td1bu1td1bu1td1b.png" />

<meta property="fc:miniapp" content='{
  "version": "next",
  "imageUrl": "https://mini-app-phi-ashen.vercel.app/Gemini_Generated_Image_td1bu1td1bu1td1b.png", 
  "button": {
    "title": "Play Base Snakes",
    "action": {
      "type": "launch_miniapp",
      "name": "Base Snakes",
      "url": "https://mini-app-phi-ashen.vercel.app/", 
      "splashImageUrl": "https://mini-app-phi-ashen.vercel.app/Gemini_Generated_Image_td1bu1td1bu1td1b.png",
      "splashBackgroundColor": "#050510"
    }
  }
}' />

<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap');

  :root {
    --base-blue: #0052FF;
    --neon-blue: #00e5ff;
    --neon-pink: #ff00ff;
    --warpcast-purple: #855DCD;
    --bg-dark: #050510;
  }

  html, body {
    overscroll-behavior: none; 
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden; 
  }

  body {
    background-color: var(--bg-dark);
    background-image: 
      linear-gradient(rgba(0, 82, 255, 0.1) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 82, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
    font-family: 'Rajdhani', sans-serif;
    touch-action: none; 
  }

  .dev-credit {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    font-size: 12px;
    color: #666;
    font-family: 'Rajdhani', sans-serif;
    z-index: 5;
    pointer-events: none;
    letter-spacing: 1px;
  }

  #ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .screen {
    pointer-events: auto;
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid var(--base-blue);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 25px rgba(0, 82, 255, 0.5);
    width: 85%;
    max-width: 320px;
    display: none;
  }
  
  .screen.active { display: block; }

  h1 { 
    font-family: 'Press Start 2P', cursive; 
    color: var(--base-blue); 
    text-shadow: 2px 2px #fff;
    font-size: 22px;
    margin-bottom: 20px;
    line-height: 1.4;
  }

  input {
    background: #111;
    border: 1px solid var(--base-blue);
    color: white;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    font-family: 'Rajdhani', sans-serif;
  }

  button {
    background: var(--base-blue);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s;
    font-family: 'Press Start 2P', cursive;
    width: 100%;
    margin-top: 8px;
    text-transform: uppercase;
  }
  
  button:active { transform: scale(0.95); }
  button:disabled { background: #555; cursor: not-allowed; }

  .btn-share {
    background: var(--warpcast-purple);
    border: 1px solid #fff;
    box-shadow: 0 0 10px var(--warpcast-purple);
    margin-bottom: 10px;
  }

  #hud {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: 400px;
    padding: 10px;
    box-sizing: border-box;
    font-size: 18px;
    font-weight: bold;
    text-shadow: 0 0 5px var(--neon-blue);
    margin-top: 25px; 
  }

  canvas {
    background: rgba(0,0,0,0.8);
    border: 2px solid var(--base-blue);
    border-radius: 12px;
    box-shadow: 0 0 15px var(--base-blue);
    display: block;
  }

  .leaderboard-container {
    margin-top: 15px;
    width: 90%;
    max-width: 350px;
    background: rgba(0,0,0,0.6);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 14px;
  }
  
  .lb-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #222;
  }
  .lb-rank { color: var(--neon-pink); font-weight: bold; }
  .lb-name { color: white; }
  .lb-score { color: var(--neon-blue); }

  .mobile-hint {
    margin-top: 10px;
    color: #666;
    font-size: 12px;
    display: none;
  }
  @media (hover: none) {
    .mobile-hint { display: block; }
  }
  
  #finalScore {
    font-size: 32px;
    color: var(--neon-blue);
    font-weight: bold;
    text-shadow: 0 0 10px var(--neon-blue);
  }

</style>
</head>
<body>

  <div class="dev-credit">developed by - @ashutosh9</div>

  <div id="hud">
    <div id="scoreDisplay">SCORE: 0</div>
    <div id="walletDisplay">üî¥ Not Connected</div>
  </div>

  <canvas id="game"></canvas>

  <div class="mobile-hint">üëÜ Swipe to turn ‚Ä¢ Tap to speed up</div>

  <div class="leaderboard-container">
    <div style="text-align:center; color: var(--base-blue); font-weight:bold; margin-bottom:5px;">üèÜ MONTHLY LEADERS</div>
    <div id="leaderboardList">Loading...</div>
  </div>

  <div id="ui-layer">
    <div id="screen-connect" class="screen active">
      <h1>BASE SNAKES</h1>
      <p style="margin-bottom:20px; color:#aaa; font-size:14px;">Connect wallet to play & save scores on-chain.</p>
      
      <button id="mainConnectBtn" onclick="window.handleConnect()">üîó CONNECT WALLET</button>
    </div>

    <div id="screen-register" class="screen">
      <h1>NEW PLAYER</h1>
      <p style="font-size:14px; color:#aaa; margin-bottom:15px;">Enter a username to link to your wallet.</p>
      <input type="text" id="usernameInput" placeholder="CryptoSnake123" maxlength="12">
      <br>
      <button onclick="registerUser()">REGISTER</button>
    </div>

    <div id="screen-start" class="screen">
      <h1 id="welcomeMsg">WELCOME</h1>
      <p style="margin-bottom:20px;">Personal Best: <span id="personalBest" style="color:var(--neon-blue)">0</span></p>
      <button onclick="unlockAudioAndStart()">‚ñ∂ START GAME</button>
    </div>

    <div id="screen-gameover" class="screen">
      <h1 style="color:var(--neon-pink)">GAME OVER</h1>
      <p>Score: <span id="finalScore">0</span></p>
      <button class="btn-share" onclick="shareScore()">üì§ SHARE ON FARCASTER</button>
      <button id="btnSave" onclick="submitScore()">üíæ SAVE ON-CHAIN</button>
      <button onclick="unlockAudioAndStart()">üîÑ RESTART</button>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>

<script type="module">
  import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

  // 1. Ready signal
  sdk.actions.ready();

  // 2. Define Global Connection Function using RAW SDK Provider (Best for Mobile)
  window.handleConnect = async () => {
    const btn = document.getElementById("mainConnectBtn");
    btn.innerText = "CONNECTING...";

    try {
        // Use the SDK provider directly first (Raw EIP-1193 Request)
        // This is safer than wrapping in Ethers immediately
        const accounts = await sdk.provider.request({ method: "eth_requestAccounts" });
        
        if (!accounts || accounts.length === 0) {
            throw new Error("No accounts returned.");
        }

        const userAddress = accounts[0];
        console.log("Connected:", userAddress);

        // Now that we have access, we initialize Ethers for contract calls
        const provider = new ethers.BrowserProvider(sdk.provider);
        const signer = await provider.getSigner();

        // Update Global State
        window.web3State = { provider, signer, userAddress };

        // Update UI
        document.getElementById("walletDisplay").innerHTML = 
            `üü¢ ${userAddress.slice(0,4)}...${userAddress.slice(-4)}`;
        
        // Init Game Contract
        initGameContract(signer);
        
        // Move to next screen
        checkRegistration(userAddress);

    } catch (err) {
        console.error("Connect Failed", err);
        // Fallback for Desktop testing if SDK provider is empty
        if (window.ethereum) {
             console.log("Falling back to window.ethereum...");
             await connectFallback();
        } else {
             alert(err.message || "Connection failed. Please try again.");
             btn.innerText = "RETRY CONNECT";
        }
    }
  };

  // Helper for desktop fallback
  async function connectFallback() {
      const provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      const userAddress = await signer.getAddress();
      
      window.web3State = { provider, signer, userAddress };
      document.getElementById("walletDisplay").innerHTML = `üü¢ ${userAddress.slice(0,4)}...`;
      initGameContract(signer);
      checkRegistration(userAddress);
  }

  // 3. Auto-Trigger on Load (Matches "working app" behavior)
  setTimeout(() => {
      window.handleConnect();
  }, 600);
</script>

<script>
// --- GAME LOGIC (Ethers v6 Updated) ---
const CONTRACT_ADDRESS = "0x1A7CcE659Ad0f71Ddc9f2Af9f4d1F155A8291BDd"; 
const ABI = [
  "function registerUser(string username) public",
  "function saveScore(uint256 score) public",
  "function getPlayer(address _addr) public view returns (string, uint256)",
  "event NewScore(address indexed player, string username, uint256 score, uint256 timestamp)",
  "event UserRegistered(address indexed player, string username)"
];

let contract; 

function initGameContract(signer) {
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

async function checkRegistration(addr) {
    try {
        if(!contract) return;
        const player = await contract.getPlayer(addr);
        // Ethers v6 Result Check
        if (!player || player[0] === "") {
            showScreen('screen-register');
        } else {
            document.getElementById("welcomeMsg").innerText = `HI, ${player[0].toUpperCase()}`;
            document.getElementById("personalBest").innerText = player[1].toString();
            showScreen('screen-start');
        }
        fetchLeaderboard();
    } catch (e) {
        console.log("Check Reg Error", e);
        showScreen('screen-register'); 
    }
}

async function registerUser() {
    const name = document.getElementById("usernameInput").value;
    if (!name || name.length > 12) return alert("Invalid Name (1-12 chars)");
    if (!contract) return alert("Wallet not connected properly.");

    try {
        const tx = await contract.registerUser(name);
        document.querySelector('#screen-register button').innerText = "REGISTERING...";
        await tx.wait();
        showScreen('screen-start');
    } catch (err) {
        alert("Tx Failed: " + err.message);
        document.querySelector('#screen-register button').innerText = "REGISTER";
    }
}

async function submitScore() {
    if (!contract) return;
    try {
        const btn = document.getElementById('btnSave');
        btn.innerText = "SIGNING...";
        btn.disabled = true;
        const tx = await contract.saveScore(score);
        btn.innerText = "MINING...";
        await tx.wait();
        btn.innerText = "SAVED! ‚úÖ";
        fetchLeaderboard(); 
    } catch (err) {
        alert("Error: " + err.message);
        document.getElementById('btnSave').disabled = false;
        document.getElementById('btnSave').innerText = "üíæ SAVE ON-CHAIN";
    }
}

async function fetchLeaderboard() {
    if (!contract) {
        document.getElementById("leaderboardList").innerText = "Connect wallet to view";
        return;
    }
    try {
        const filter = contract.filters.NewScore();
        const events = await contract.queryFilter(filter, -2000); 
        
        let scores = events.map(e => ({
            name: e.args[1], 
            score: Number(e.args[2])
        }));
        
        const bestScores = {};
        scores.forEach(s => {
            if (!bestScores[s.name] || s.score > bestScores[s.name]) {
                bestScores[s.name] = s.score;
            }
        });
        
        const sorted = Object.entries(bestScores)
            .map(([name, score]) => ({ name, score }))
            .sort((a,b) => b.score - a.score)
            .slice(0, 5);
        
        const list = document.getElementById("leaderboardList");
        if(sorted.length === 0) {
            list.innerHTML = "<div style='text
